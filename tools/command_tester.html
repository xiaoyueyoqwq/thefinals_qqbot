<!--
    *Command Tester UI*
    *This is the UI file for Command Tester, please do not delete this file*
-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommandLine</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #f0f2f5;
            --message-background: #ffffff;
            --bot-message-background: #f0f2f5;
            --border-color: #dee2e6;
            --text-color: #212529;
            --placeholder-color: #6c757d;
            --hover-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --fast-color: #28a745;
            --normal-color: #ffc107;
            --slow-color: #dc3545;
            --bg-color: #fafafa;
            --panel-bg: #ffffff;
            --text-secondary: #666666;
            --bot-msg-bg: #f0f7ff;
            --user-msg-bg: #f2f2f7;
            --error-color: #ff453a;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #0070f3;
                --primary-hover: #3291ff;
                --bg-color: #111111;
                --panel-bg: #1c1c1e;
                --border-color: #333333;
                --text-color: #f2f2f7;
                --text-secondary: #8e8e93;
                --bot-msg-bg: #1c1c2e;
                --user-msg-bg: #2c2c2e;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 1.5rem;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            max-width: 500px;
            animation: fadeIn 0.8s ease-out;
        }

        .content {
            display: flex;
            flex: 1;
            gap: 1.5rem;
        }

        .chat-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background-color: var(--panel-bg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            animation: slideUp 0.5s ease-out;
        }

        .chat-container:hover {
            box-shadow: var(--shadow-md);
        }

        .sidebar {
            flex: 1;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: slideUp 0.7s ease-out;
            position: sticky;
            top: 1rem;
            height: calc(100vh - 2rem);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 20px;
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: var(--transition);
        }

        .panel:hover {
            box-shadow: var(--shadow-md);
        }

        .panel-header {
            padding: 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-body {
            padding: 1rem;
        }

        .command-list-wrapper {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }

        .command-list-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .command-list-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .command-list-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 20px;
        }

        .command-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .command-group {
            margin-bottom: 1.25rem;
        }

        .command-group-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .command-item {
            margin-top: 0.5rem;
            padding: 0.65rem 0.85rem;
            background-color: var(--bg-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .command-item:hover {
            background-color: var(--bot-msg-bg);
            transform: translateY(-1px);
        }

        .command-title {
            font-weight: 500;
            color: var(--primary-color);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .command-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--text-secondary);
            border-radius: 20px;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            position: relative;
            animation: messageAppear 0.3s ease-out;
            margin-bottom: 2rem;
        }

        .message-actions {
            position: absolute;
            right: 0;
            bottom: -2rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s ease;
            height: 1.75rem;
            z-index: 1;
        }

        .message:hover .message-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .message-action-btn {
            height: 1.75rem;
            padding: 0 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: var(--transition);
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .message-action-btn:hover {
            border-color: var(--primary-color);
            background: var(--bg-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .message-action-btn svg {
            width: 0.875rem;
            height: 0.875rem;
            fill: currentColor;
        }

        .clickable-command {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            transition: var(--transition);
        }

        .clickable-command:hover {
            color: var(--primary-hover);
        }

        .bot-typing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            border: 1px solid var(--border-color);
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-msg-bg);
            border: 1px solid rgba(0, 112, 243, 0.2);
        }

        .message-header {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            color: white;
            font-weight: 600;
        }

        .user-avatar {
            background-color: var(--text-secondary);
        }

        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.9375rem;
        }

        .input-container {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--panel-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .input-wrapper {
            display: flex;
            position: relative;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.2);
            transform: translateY(-1px);
        }

        .command-input {
            flex: 1;
            padding: 0.875rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            resize: none;
            font-family: inherit;
            font-size: 0.9375rem;
            line-height: 1.5;
            outline: none;
            background: transparent;
            color: var(--text-color);
            min-height: 3.25rem;
            max-height: 9.75rem;
        }

        .command-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .send-button {
            margin: 0.375rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0 1.25rem;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-width: 5rem;
            height: 2.5rem;
        }

        .send-button svg {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .send-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .send-button:hover svg {
            transform: translateX(2px);
        }

        .send-button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .send-button:disabled svg {
            transform: none;
        }

        .input-tips {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        .error-message {
            background-color: rgba(255, 69, 58, 0.1);
            color: #d32f2f;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
            font-size: 0.875rem;
            position: relative;
            animation: slideIn 0.3s ease-out;
            border: 1px solid rgba(255, 69, 58, 0.2);
        }

        .error-message pre {
            background-color: rgba(0, 0, 0, 0.05);
            color: #666;
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .error-message .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 69, 58, 0.1);
            border: 1px solid rgba(255, 69, 58, 0.2);
            color: #d32f2f;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .error-message .copy-button:hover {
            background-color: rgba(255, 69, 58, 0.2);
        }

        .error-message .error-type {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #d32f2f;
        }

        .error-message .error-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 69, 58, 0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-label {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setting-icon {
            width: 1rem;
            height: 1rem;
            opacity: 0.7;
        }

        /* 开关样式 */
        .toggle {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: var(--transition);
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        .button {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: 0.5rem;
        }

        .button:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0, 112, 243, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 响应式设计 */
        @media (max-width: 900px) {
            .container {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .content {
                flex-direction: column;
            }

            .sidebar {
                max-width: none;
                order: -1;
                position: relative;
                top: 0;
                height: auto;
            }

            .command-list-wrapper {
                max-height: 180px;
            }
        }

        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .message {
                max-width: 90%;
            }
        }

        /* 执行时间显示样式 */
        .execution-time {
            position: absolute;
            top: -20px;
            right: -10px;
            font-size: 12px;
            color: var(--text-color);
            padding: 2px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transform: translateX(10px);
            animation: timeAppear 0.3s ease-out forwards;
            animation-delay: 0.1s;
        }

        @keyframes timeAppear {
            from {
                opacity: 0;
                transform: translateX(10px);
            }
            to {
                opacity: 0.8;
                transform: translateX(0);
            }
        }

        .execution-time:hover {
            opacity: 1;
            transform: translateX(-5px);
            transition: all 0.2s ease-out;
        }

        .execution-time svg {
            width: 14px;
            height: 14px;
        }

        .execution-time.fast {
            color: var(--fast-color);
        }

        .execution-time.normal {
            color: var(--normal-color);
        }

        .execution-time.slow {
            color: var(--slow-color);
        }

        .execution-time.very-slow {
            color: var(--danger-color);
        }

        .execution-time-text {
            display: none;
            transform: translateX(5px);
            transition: transform 0.2s ease-out;
        }

        .execution-time:hover .execution-time-text {
            display: inline;
            transform: translateX(0);
        }

        /* 消息容器相对定位 */
        .message {
            position: relative;
        }

        /* 强制发送按钮样式 */
        .force-send-button {
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            opacity: 0.9;
        }

        .force-send-button:hover {
            opacity: 1;
            transform: translateY(-1px);
        }

        .force-send-button svg {
            margin-right: 4px;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .error-message ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .error-message li {
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div style="display: none;">
        <!-- SVG Sprite -->
        <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
            <symbol id="icon-retry" viewBox="0 0 24 24">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </symbol>
            <symbol id="icon-send" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </symbol>
            <symbol id="icon-command" viewBox="0 0 24 24">
                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </symbol>
            <symbol id="icon-fast" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor"/>
            </symbol>
            <symbol id="icon-normal" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" opacity="0.8"/>
            </symbol>
            <symbol id="icon-slow" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" opacity="0.6"/>
            </symbol>
            <symbol id="icon-very-slow" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" opacity="0.4"/>
            </symbol>
        </svg>
    </div>
    <div class="container">
        <header>
            <h1>CommandLine</h1>
            <p class="subtitle">v0.0.1 Build 202503060109</p>
        </header>
        <div class="content">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot-message">
                        <div class="message-header">
                            <div class="message-avatar">S</div>
                            <span>系统</span>
                        </div>
                        <div class="message-content">👋 欢迎使用CommandLine。它可以在不启动QQ机器人服务的情况下本地测试所有命令。

请在下方输入框中输入命令，例如 <span class="clickable-command" data-command="/ds Dizzy">/ds Dizzy</span> 来测试深度搜索命令。

你也可以在右侧点击命令快速测试。</div>
                    </div>
                </div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea class="command-input" id="commandInput" placeholder="输入命令，例如: /ds Dizzy" rows="2"></textarea>
                        <button class="send-button" id="sendButton">
                            <svg><use href="#icon-send"/></svg>
                            发送
                        </button>
                    </div>
                    <div class="input-tips">
                        <span>提示: 按Enter发送，Shift+Enter换行</span>
                        <span id="charCount">0 个字符</span>
                    </div>
                </div>
            </div>
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-header">可用命令</div>
                    <div class="panel-body">
                        <div class="command-list-wrapper">
                            <div class="command-list" id="commandList">
                                <!-- 命令列表将通过JS动态加载 -->
                                <div style="display: flex; align-items: center; justify-content: center; padding: 1rem;">
                                    <div class="loading"></div>
                                    <span>加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">设置</div>
                    <div class="panel-body">
                        <div class="settings-list">
                            <div class="setting-item">
                                <label class="setting-label" for="showTimestamp">
                                    <svg class="setting-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    显示时间戳
                                </label>
                                <label class="toggle">
                                    <input type="checkbox" id="showTimestamp" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label" for="autoScroll">
                                    <svg class="setting-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M19 12L12 19L5 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    自动滚动
                                </label>
                                <label class="toggle">
                                    <input type="checkbox" id="autoScroll" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label" for="darkMode">
                                    <svg class="setting-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5M17.6859 17.69L18.5 18.5M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    跟随系统
                                </label>
                                <label class="toggle">
                                    <input type="checkbox" id="darkMode" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <button class="button" id="clearButton">清空聊天记录</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 将 sendCommand 函数暴露到全局作用域
        let globalSendCommand;

        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chatMessages');
            const commandInput = document.getElementById('commandInput');
            const sendButton = document.getElementById('sendButton');
            const commandList = document.getElementById('commandList');
            const showTimestamp = document.getElementById('showTimestamp');
            const autoScroll = document.getElementById('autoScroll');
            const darkMode = document.getElementById('darkMode');
            const clearButton = document.getElementById('clearButton');
            const charCount = document.getElementById('charCount');
            
            let isWaitingForResponse = false;

            // 设置暗模式
            function setColorScheme() {
                if (darkMode.checked) {
                    document.body.classList.remove('force-light', 'force-dark');
                } else {
                    document.body.classList.add('force-light');
                    document.body.classList.remove('force-dark');
                }
            }

            darkMode.addEventListener('change', setColorScheme);
            setColorScheme();

            // 字符计数
            commandInput.addEventListener('input', function() {
                charCount.textContent = `${this.value.length} 个字符`;
            });

            // 加载命令列表
            fetchCommandList();

            // 获取执行时间的图标和类名
            function getExecutionTimeInfo(time) {
                if (time < 3000) {  // 小于 3s 认为是超快
                    return {
                        icon: 'fast',
                        class: 'fast',
                        text: '响应超快'
                    };
                } else if (time < 4000) {  // 小于 4s 认为是不错
                    return {
                        icon: 'normal',
                        class: 'normal',
                        text: '响应不错'
                    };
                } else if (time < 5000) {  // 小于 5s 认为是慢
                    return {
                        icon: 'slow',
                        class: 'slow',
                        text: '响应较慢'
                    };
                } else {  // 大于 5s 认为是非常慢
                    return {
                        icon: 'very-slow',
                        class: 'very-slow',
                        text: '响应非常慢'
                    };
                }
            }

            // 添加消息到聊天区域
            function addMessage(content, type, imageData = null, executionTime = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                
                const header = document.createElement('div');
                header.className = 'message-header';
                
                const avatar = document.createElement('div');
                avatar.className = `message-avatar ${type === 'user' ? 'user-avatar' : ''}`;
                avatar.textContent = type === 'user' ? 'U' : 'B';
                
                const headerText = document.createElement('span');
                const timestamp = showTimestamp.checked ? getTimestamp() : '';
                headerText.textContent = type === 'user' ? `你 ${timestamp}` : `机器人 ${timestamp}`;
                
                header.appendChild(avatar);
                header.appendChild(headerText);
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                // 如果是系统消息，处理可点击的命令
                if (type === 'bot' && content && content.includes('/')) {
                    const commandRegex = /\/[a-zA-Z]+\s+[^\s]+/g;
                    let lastIndex = 0;
                    let match;
                    let processedContent = '';

                    while ((match = commandRegex.exec(content)) !== null) {
                        processedContent += content.slice(lastIndex, match.index);
                        processedContent += `<span class="clickable-command" data-command="${match[0]}">${match[0]}</span>`;
                        lastIndex = match.index + match[0].length;
                    }
                    processedContent += content.slice(lastIndex);
                    messageContent.innerHTML = processedContent;

                    // 添加点击事件
                    messageContent.querySelectorAll('.clickable-command').forEach(cmd => {
                        cmd.addEventListener('click', () => {
                            const command = cmd.getAttribute('data-command');
                            commandInput.value = command;
                            sendCommand();
                        });
                    });
                } else if (content) {
                    messageContent.textContent = content;
                }
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(messageContent);

                // 添加执行时间显示（仅对机器人消息）
                if (type === 'bot' && executionTime !== null) {
                    const timeInfo = getExecutionTimeInfo(executionTime);
                    const timeDiv = document.createElement('div');
                    timeDiv.className = `execution-time ${timeInfo.class}`;
                    timeDiv.innerHTML = `
                        <svg><use href="#icon-${timeInfo.icon}"/></svg>
                        <span>${executionTime}ms</span>
                        <span class="execution-time-text">${timeInfo.text}</span>
                    `;
                    messageDiv.appendChild(timeDiv);
                }

                // 如果有图片数据,添加图片
                if (imageData) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'message-image';
                    imageContainer.style.cssText = 'margin-top: 10px; max-width: 100%; overflow: hidden; border-radius: 8px;';
                    
                    const image = document.createElement('img');
                    image.src = `data:image/jpeg;base64,${imageData}`;
                    image.style.cssText = 'max-width: 100%; height: auto; display: block; cursor: pointer;';
                    image.onclick = () => {
                        // 创建全屏预览
                        const preview = document.createElement('div');
                        preview.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.9);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            z-index: 1000;
                            cursor: pointer;
                        `;
                        
                        const previewImg = document.createElement('img');
                        previewImg.src = image.src;
                        previewImg.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
                        
                        preview.appendChild(previewImg);
                        document.body.appendChild(preview);
                        
                        // 点击关闭预览
                        preview.onclick = () => preview.remove();
                    };
                    
                    imageContainer.appendChild(image);
                    messageDiv.appendChild(imageContainer);
                }

                // 添加消息操作按钮
                const actions = document.createElement('div');
                actions.className = 'message-actions';

                if (type === 'user') {
                    // 重试按钮
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'message-action-btn';
                    retryBtn.innerHTML = '<svg><use href="#icon-retry"/></svg>重试';
                    retryBtn.addEventListener('click', () => {
                        commandInput.value = content;
                        sendCommand();
                    });
                    actions.appendChild(retryBtn);
                }

                // 复制按钮 (对所有消息都添加)
                const copyBtn = document.createElement('button');
                copyBtn.className = 'message-action-btn';
                copyBtn.innerHTML = '<svg><use href="#icon-copy"/></svg>复制';
                copyBtn.addEventListener('click', () => {
                    // 如果有图片,复制图片链接
                    if (imageData) {
                        const imgUrl = `data:image/jpeg;base64,${imageData}`;
                        navigator.clipboard.writeText(imgUrl).then(() => {
                            const originalText = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<svg><use href="#icon-copy"/></svg>已复制图片链接';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                            }, 2000);
                        });
                    } else {
                        navigator.clipboard.writeText(content).then(() => {
                            const originalText = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<svg><use href="#icon-copy"/></svg>已复制';
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                            }, 2000);
                        });
                    }
                });
                actions.appendChild(copyBtn);
                messageDiv.appendChild(actions);
                
                chatMessages.appendChild(messageDiv);
                
                if (autoScroll.checked) {
                    scrollToBottom();
                }
            }

            // 添加等待动画
            function addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'bot-typing';
                typingDiv.innerHTML = `
                    <div class="message-avatar">B</div>
                    <span>正在输入</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                if (autoScroll.checked) {
                    scrollToBottom();
                }
                return typingDiv;
            }

            // 发送命令
            async function sendCommand(forceSend = false) {
                const command = commandInput.value.trim();
                if (command === '' || isWaitingForResponse) return;

                // 检查命令是否存在于命令列表中
                if (!forceSend && command.startsWith('/')) {
                    const commandName = command.split(' ')[0].substring(1); // 获取命令名称(不含参数)
                    const commandExists = Object.keys(window.availableCommands || {}).includes(commandName);
                    
                    if (!commandExists) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.innerHTML = `
                            <div style="margin-bottom: 10px;">命令 /${commandName} 不存在。请检查:</div>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>命令名称是否正确</li>
                                <li>对应的命令代码是否已注册</li>
                                <li>命令插件是否已正确加载</li>
                            </ol>
                            <div class="force-send-button" id="forceSendBtn">
                                <svg viewBox="0 0 24 24" width="16" height="16" style="margin-right: 4px;">
                                    <path d="M12 2L4 20l8-3 8 3L12 2z" fill="currentColor"/>
                                </svg>
                                强制发送
                            </div>
                        `;
                        chatMessages.appendChild(errorDiv);

                        // 使用 DOM 方式绑定点击事件
                        const forceSendBtn = errorDiv.querySelector('#forceSendBtn');
                        forceSendBtn.addEventListener('click', () => sendCommand(true));

                        if (autoScroll.checked) {
                            scrollToBottom();
                        }
                        return;
                    }
                }
                
                // 添加用户消息
                addMessage(command, 'user');
                
                // 清空输入框
                commandInput.value = '';
                charCount.textContent = '0 个字符';
                
                // 发送请求
                isWaitingForResponse = true;
                sendButton.disabled = true;
                
                // 添加等待动画
                const typingIndicator = addTypingIndicator();
                
                fetch('/api/execute_command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command })
                })
                .then(response => response.json())
                .then(data => {
                    // 移除等待动画
                    typingIndicator.remove();
                    
                    if (data.error) {
                        addErrorMessage(data.error);
                    } else {
                        addMessage(data.response, 'bot', data.image, data.execution_time);
                    }
                })
                .catch(error => {
                    // 移除等待动画
                    typingIndicator.remove();
                    
                    addErrorMessage('服务器连接错误，请检查后端服务是否运行。');
                    console.error('Error:', error);
                })
                .finally(() => {
                    isWaitingForResponse = false;
                    sendButton.disabled = false;
                    commandInput.focus();
                });
            }

            // 将 sendCommand 函数暴露到全局作用域
            globalSendCommand = sendCommand;

            // 添加错误消息
            function addErrorMessage(content) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = content;
                chatMessages.appendChild(errorDiv);
                
                if (autoScroll.checked) {
                    scrollToBottom();
                }
            }

            // 获取格式化的时间戳
            function getTimestamp() {
                const now = new Date();
                return `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
            }

            // 滚动到底部
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // 获取命令列表
            function fetchCommandList() {
                fetch('/api/command_list')
                .then(response => response.json())
                .then(data => {
                    commandList.innerHTML = '';
                    
                    if (data.error) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = data.error;
                        commandList.appendChild(errorDiv);
                        return;
                    }

                    // 保存命令列表到全局变量
                    window.availableCommands = data.commands;
                    
                    // 按插件名分组命令
                    const pluginCommands = {};
                    
                    for (const [command, info] of Object.entries(data.commands)) {
                        const pluginName = info.plugin || '其他';
                        
                        if (!pluginCommands[pluginName]) {
                            pluginCommands[pluginName] = [];
                        }
                        
                        pluginCommands[pluginName].push({
                            command: command,
                            description: info.description || '无描述',
                            hidden: info.hidden || false
                        });
                    }
                    
                    // 为每个插件创建命令区域
                    for (const [pluginName, commands] of Object.entries(pluginCommands)) {
                        // 跳过隐藏的命令
                        const visibleCommands = commands.filter(cmd => !cmd.hidden);
                        if (visibleCommands.length === 0) continue;
                        
                        const commandGroup = document.createElement('div');
                        commandGroup.className = 'command-group';
                        
                        const groupTitle = document.createElement('div');
                        groupTitle.className = 'command-group-title';
                        groupTitle.textContent = pluginName;
                        
                        commandGroup.appendChild(groupTitle);
                        
                        // 添加命令
                        visibleCommands.forEach(cmd => {
                            const cmdItem = document.createElement('div');
                            cmdItem.className = 'command-item';
                            cmdItem.setAttribute('data-command', `/${cmd.command}`);
                            
                            const cmdTitle = document.createElement('div');
                            cmdTitle.className = 'command-title';
                            cmdTitle.textContent = `/${cmd.command}`;
                            
                            const cmdDesc = document.createElement('div');
                            cmdDesc.className = 'command-description';
                            cmdDesc.textContent = cmd.description;
                            
                            cmdItem.appendChild(cmdTitle);
                            cmdItem.appendChild(cmdDesc);
                            
                            cmdItem.addEventListener('click', function() {
                                commandInput.value = this.getAttribute('data-command');
                                commandInput.focus();
                                charCount.textContent = `${commandInput.value.length} 个字符`;
                            });
                            
                            commandGroup.appendChild(cmdItem);
                        });
                        
                        commandList.appendChild(commandGroup);
                    }

                    // 检查是否有命令
                    if (commandList.children.length === 0) {
                        commandList.innerHTML = '<div style="padding: 1rem; color: var(--text-secondary);">没有可用的命令</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching command list:', error);
                    commandList.innerHTML = '<div class="error-message">无法获取命令列表，请检查后端服务</div>';
                });
            }

            // 按钮事件
            sendButton.addEventListener('click', sendCommand);
            
            // 输入框事件
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendCommand();
                }
            });
            
            // 清空聊天记录
            clearButton.addEventListener('click', function() {
                // 保留第一条欢迎消息
                const welcomeMessage = chatMessages.firstChild;
                chatMessages.innerHTML = '';
                chatMessages.appendChild(welcomeMessage);
            });

            // 初始化欢迎消息中的可点击命令
            document.querySelectorAll('.clickable-command').forEach(cmd => {
                cmd.addEventListener('click', () => {
                    const command = cmd.getAttribute('data-command');
                    commandInput.value = command;
                    sendCommand();
                });
            });
        });
    </script>
</body>
</html> 