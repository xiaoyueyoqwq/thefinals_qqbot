# Plugin CORE V3.4 æ’ä»¶å¼€å‘æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªç®€å•å¥½ç”¨çš„æ’ä»¶æ¡†æ¶,å¸®ä½ è½»æ¾å®ç°å„ç§æœºå™¨äººåŠŸèƒ½ã€‚ä¸ç®¡æ˜¯æ–°æ‰‹è¿˜æ˜¯è€æ‰‹,éƒ½èƒ½å¿«é€Ÿä¸Šæ‰‹ã€‚

! ä½¿ç”¨ä¾‹å­åœ¨plugins\test_hello.py

## æœ€æ–°ç‰¹æ€§ (V3.4)

### æ‹‰é—¸æ¨¡å¼
ç°åœ¨æ’ä»¶æ”¯æŒä¸€é”®æ‹‰é—¸äº†ï¼å½“æœºå™¨äººå‡ºç°å¼‚å¸¸æˆ–éœ€è¦ç»´æŠ¤æ—¶ï¼Œå¯ä»¥å¿«é€Ÿåœç”¨æ’ä»¶çš„å“åº”:

```python
# è®¾ç½®å•ä¸ªæ’ä»¶ä¸ºæ‹‰é—¸çŠ¶æ€
plugin.maintenance = True

# æ‹‰é—¸é™¤å½“å‰æ’ä»¶å¤–çš„æ‰€æœ‰æ’ä»¶
for plugin in self._plugin_manager.plugins.values():
    if plugin != self:  # ä¿ç•™å½“å‰æ’ä»¶å“åº”èƒ½åŠ›
        plugin.maintenance = True

# æ’ä»¶æ‹‰é—¸å:
# - ä¸ä¼šå“åº”ä»»ä½•æ–°æ¶ˆæ¯
# - ä¸ä¼šå¤„ç†ä»»ä½•äº‹ä»¶
# - å·²æœ‰çš„æ•°æ®å’ŒçŠ¶æ€ä¼šä¿æŒä¸å˜
```

æ³¨æ„äº‹é¡¹ï¼š
1. å…¨å±€æ‹‰é—¸æ—¶ï¼Œå»ºè®®ä¿ç•™è‡³å°‘ä¸€ä¸ªæ’ä»¶çš„å“åº”èƒ½åŠ›ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ‰§è¡Œæ¢å¤æ“ä½œ
2. æ‹‰é—¸çŠ¶æ€ä¼šæŒç»­åˆ°æ‰‹åŠ¨æ¢å¤æˆ–é‡å¯æœºå™¨äºº

ä½¿ç”¨ç¤ºä¾‹ï¼š
```python
class MaintenancePlugin(Plugin):
    """ç»´æŠ¤æ§åˆ¶æ’ä»¶"""
    
    @on_command("shutdown", "æ‹‰é—¸æ§åˆ¶", hidden=True)
    async def shutdown_control(self, handler, content):
        if content == "all":
            # æ‹‰é—¸é™¤è‡ªå·±å¤–çš„æ‰€æœ‰æ’ä»¶
            for plugin in self._plugin_manager.plugins.values():
                if plugin != self:
                    plugin.maintenance = True
            await self.reply(handler, "âœ… å·²æ‹‰é—¸å…¶ä»–æ’ä»¶ï¼Œå½“å‰æ’ä»¶ä¿æŒå“åº”")
            
        elif content == "resume":
            # æ¢å¤æ‰€æœ‰æ’ä»¶
            for plugin in self._plugin_manager.plugins.values():
                plugin.maintenance = False
            await self.reply(handler, "âœ… å·²æ¢å¤æ‰€æœ‰æ’ä»¶è¿è¡Œ")
```

### å›¾ç‰‡å¤„ç†ä¼˜åŒ–
ç®€åŒ–äº†å›¾ç‰‡å‘é€æ¥å£ï¼Œç»Ÿä¸€ä½¿ç”¨Base64ç¼–ç :

```python
# å‘é€çº¯å›¾ç‰‡æ¶ˆæ¯
await self.reply_image(handler, image_data)

# å‘é€å›¾æ–‡æ··æ’æ¶ˆæ¯
await self.reply(handler, "çœ‹çœ‹è¿™å¼ å›¾ç‰‡", image_data)
```

* æˆ‘ä»¬ç§»é™¤äº†OSSä¸­è½¬ï¼Œæ‰€æœ‰å›¾ç‰‡ç°åœ¨ä¼šç›´æ¥ä½¿ç”¨Base64ç¼–ç å‘é€
* æ–°å¢å›¾æ–‡æ··æ’åŠŸèƒ½ï¼Œæ”¯æŒåœ¨æ–‡æœ¬æ¶ˆæ¯ä¸­åµŒå…¥å›¾ç‰‡

ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œæ—§çš„APIè°ƒç”¨æ–¹å¼ä»ç„¶å¯ç”¨ï¼Œä½†ä¼šæ”¶åˆ°è­¦å‘Šæç¤ºã€‚å»ºè®®å¼€å‘è€…å°½å¿«æ›´æ–°åˆ°æ–°çš„æ¥å£ã€‚

ç¤ºä¾‹ï¼š
```python
class ImagePlugin(Plugin):
    """å›¾ç‰‡å¤„ç†æ’ä»¶ç¤ºä¾‹"""
    
    @on_command("image", "å‘é€å›¾ç‰‡ç¤ºä¾‹")
    async def send_image(self, handler, content):
        # åŠ è½½å›¾ç‰‡æ•°æ®
        with open("image.png", "rb") as f:
            image_data = f.read()
            
        # å‘é€çº¯å›¾ç‰‡
        await self.reply_image(handler, image_data)
        
        # å‘é€å›¾æ–‡æ··æ’
        await self.reply(handler, "è¿™æ˜¯ä¸€å¼ å¯çˆ±çš„å›¾ç‰‡~", image_data)
```

### çµæ´»çš„å‘½ä»¤é…ç½®
ç°åœ¨å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è‡ªå®šä¹‰å‘½ä»¤è¡Œä¸ºäº†ï¼

```yaml
command:
  prefix_required: true   # æ˜¯å¦å¼ºåˆ¶è¦æ±‚å‘½ä»¤å‰ç¼€
  prefix: "/"            # è‡ªå®šä¹‰å‘½ä»¤å‰ç¼€
  respond_to_unknown: true  # æ˜¯å¦å“åº”æœªçŸ¥å‘½ä»¤
```

ç¤ºä¾‹æ•ˆæœ:
```python
# é»˜è®¤é…ç½® (éœ€è¦å‰ç¼€)
@on_command("help")
async def help(self, handler):
    # åªå“åº” "/help"
    await self.reply(handler, "è¿™æ˜¯å¸®åŠ©ä¿¡æ¯")

# å…³é—­å‰ç¼€è¦æ±‚
# command.prefix_required = false
@on_command("help")
async def help(self, handler):
    # åŒæ—¶å“åº” "help" å’Œ "/help"
    await self.reply(handler, "è¿™æ˜¯å¸®åŠ©ä¿¡æ¯")

# è‡ªå®šä¹‰å‰ç¼€
# command.prefix = "!"
@on_command("help")
async def help(self, handler):
    # åªå“åº” "!help"
    await self.reply(handler, "è¿™æ˜¯å¸®åŠ©ä¿¡æ¯")
```

### å¯é…ç½®çš„æœªçŸ¥å‘½ä»¤å“åº”
ä¸æƒ³è®©æœºå™¨äººå¯¹æœªçŸ¥å‘½ä»¤åšå‡ºå›åº”ï¼Ÿç°åœ¨å¯ä»¥å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼š

```yaml
command:
  respond_to_unknown: false  # å…³é—­æœªçŸ¥å‘½ä»¤å“åº”
```

è¿™æ ·å½“ç”¨æˆ·è¾“å…¥æœªçŸ¥å‘½ä»¤æ—¶ï¼Œæœºå™¨äººå°±ä¼šä¿æŒæ²‰é»˜äº†~

## V3.1.0 ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

### å‘½ä»¤éšè—åŠŸèƒ½
ç°åœ¨ä½ å¯ä»¥åˆ›å»ºéšè—å‘½ä»¤äº†ï¼è¿™äº›å‘½ä»¤ä¸ä¼šåœ¨å‘½ä»¤åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼Œä½†ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼š

```python
@on_command("secret", "è¿™æ˜¯ä¸ªéšè—å‘½ä»¤", hidden=True)
async def secret_command(self, handler, content):
    await self.reply(handler, "ä½ å‘ç°äº†éšè—å‘½ä»¤ï¼")
```

### ä¼˜åŒ–çš„æœªçŸ¥å‘½ä»¤å¤„ç†
- æ›´æ™ºèƒ½çš„å‘½ä»¤æç¤º
- æŒ‰å­—æ¯é¡ºåºæ’åºçš„å‘½ä»¤åˆ—è¡¨
- éšè—å‘½ä»¤ä¸ä¼šæ˜¾ç¤ºåœ¨æç¤ºä¸­
- é˜²æ­¢å¤šä¸ªæ’ä»¶åŒæ—¶å“åº”æœªçŸ¥å‘½ä»¤

### å¢å¼ºçš„å¹¶å‘å¤„ç†
æ›´ç¨³å®šçš„å¹¶å‘ä»»åŠ¡å¤„ç†ï¼š

```python
# åˆ›å»ºå¤šä¸ªå¹¶å‘ä»»åŠ¡
tasks = []
for i in range(5):
    tasks.append(self._process_task(handler, i))
    
# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
await asyncio.gather(*tasks)
```

### å¯é çš„çŠ¶æ€ç®¡ç†
æ”¹è¿›çš„çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶ï¼š

```python
# è®¾ç½®çŠ¶æ€ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
await self.set_state("user_status", "online")

# è·å–çŠ¶æ€ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
status = self.get_state("user_status", "offline")

# æ¸…é™¤çŠ¶æ€ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
await self.clear_state("user_status")
```

---

## å¿«é€Ÿä¸Šæ‰‹ï¼šåˆ›å»ºæ’ä»¶

åˆ›å»ºæ’ä»¶è¶…ç®€å•,ç»§æ‰¿ `Plugin` ç±»å°±è¡Œäº†:

```python
from core.plugin import Plugin, on_command

class HelloPlugin(Plugin):
    """ä¸€ä¸ªç®€å•çš„é—®å€™æ’ä»¶"""
    
    @on_command("hello", "æ‰“ä¸ªæ‹›å‘¼")
    async def say_hello(self, handler, content):
        await self.reply(handler, "ä½ å¥½å‘€~")
```

æŠŠè¿™ä¸ªæ–‡ä»¶æ”¾åˆ° `plugins/` ç›®å½•ä¸‹,ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åŠ è½½å®ƒã€‚åˆ é™¤æ–‡ä»¶å°±ä¼šè‡ªåŠ¨å¸è½½,æ–¹ä¾¿å¾—å¾ˆã€‚

## ä¸»è¦åŠŸèƒ½

### äº‹ä»¶ç³»ç»Ÿ

äº‹ä»¶ç³»ç»Ÿå°±åƒä¸€ä¸ª"ç›‘å¬è€…",å½“æœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿæ—¶(æ¯”å¦‚æ”¶åˆ°æ¶ˆæ¯ã€æœ‰äººåŠ ç¾¤),å®ƒä¼šé€šçŸ¥ä½ çš„æ’ä»¶:

```python
# ä½¿ç”¨å†…ç½®äº‹ä»¶ç±»å‹
@on_event(EventType.MESSAGE)
async def on_message(self, event):
    print(f"æ”¶åˆ°æ–°æ¶ˆæ¯: {event.data}")

# ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶
@on_event("custom.event")
async def on_custom(self, event):
    print(f"æ”¶åˆ°è‡ªå®šä¹‰äº‹ä»¶: {event.data}")
```

### æ¶ˆæ¯å¤„ç†

å¯ä»¥ç”¨å‘½ä»¤ã€å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼æ¥è§¦å‘åŠŸèƒ½:

```python
# å…³é”®è¯è§¦å‘    
@on_keyword("æ—©å®‰", "æ—©ä¸Šå¥½")
async def morning(self, handler, content):  # content å‚æ•°åŒ…å«å®Œæ•´æ¶ˆæ¯å†…å®¹
    await self.reply(handler, "æ—©å®‰")
```

### å›¾ç‰‡å¤„ç†
ç›®å‰æ”¯æŒä¸¤ç§æ–¹å¼å‘é€å›¾ç‰‡:

```python
# 1. æ¨èæ–¹å¼:ç›´æ¥ä½¿ç”¨ Base64
await self.reply_image(handler, image_data)

# 2. å…¼å®¹æ–¹å¼(å°†åœ¨æœªæ¥ç‰ˆæœ¬ç§»é™¤)
await self.reply_image(handler, image_data, use_base64=False)
```

### æ•°æ®å­˜å‚¨

æ’ä»¶çš„æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜,ä½ åªéœ€è¦:

```python
# ä¿å­˜æ•°æ®
await self.save_data({"åå­—": "å°æ˜", "ç­‰çº§": 5})

# è¯»å–æ•°æ®
data = await self.load_data()
print(f"åå­—æ˜¯: {data['åå­—']}")
```

### çŠ¶æ€ç®¡ç†

å¯ä»¥æ–¹ä¾¿åœ°è®°å½•å’Œæ›´æ–°çŠ¶æ€:

```python
# è®°å½•çŠ¶æ€
await self.set_state("åœ¨çº¿äººæ•°", 100)

# è·å–çŠ¶æ€
äººæ•° = self.get_state("åœ¨çº¿äººæ•°", 0)  # 0æ˜¯é»˜è®¤å€¼

# æ¸…é™¤çŠ¶æ€
await self.clear_state("åœ¨çº¿äººæ•°")
```

## é«˜çº§åŠŸèƒ½

### çƒ­é‡è½½

æ”¹äº†ä»£ç ä¸ç”¨é‡å¯,ç›´æ¥çƒ­é‡è½½:

```python
await plugin.reload()  # ä¿å­˜çŠ¶æ€å¹¶åŠ è½½æ–°ä»£ç 
```

### æ’ä»¶ä¾èµ–

å¦‚æœä½ çš„æ’ä»¶éœ€è¦ä¾èµ–å…¶ä»–æ’ä»¶:

```python
class MyPlugin(Plugin):
    dependencies = ["æ•°æ®åº“æ’ä»¶", "å·¥å…·æ’ä»¶"]
```

## FAQ

### æ’ä»¶æ— æ³•åŠ è½½ï¼Œæ€ä¹ˆåŠï¼Ÿ

1. ç¡®ä¿æ’ä»¶ç±»ç»§æ‰¿äº† `Plugin` åŸºç±»ã€‚
2. æ£€æŸ¥æ’ä»¶åç§°æ˜¯å¦å”¯ä¸€ã€‚
3. æŸ¥çœ‹æ—¥å¿—å®šä½å…·ä½“é”™è¯¯ã€‚

### å¦‚ä½•è°ƒè¯•æ’ä»¶ï¼Ÿ

- ä½¿ç”¨ `from utils.logger import bot_logger/log` æ‰“å°è°ƒè¯•ä¿¡æ¯ã€‚
- è®¾ç½®æ–­ç‚¹æˆ–ç›´æ¥åœ¨ä»£ç ä¸­æ‰“å°å˜é‡å€¼ã€‚

### æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’ä»¶çš„æ•°æ®å­˜å‚¨åœ¨ `æ ¹ç›®å½•/data/plugins/<æ’ä»¶å>/` ç›®å½•ä¸‹ã€‚

### æˆ‘ä¸æƒ³ç”¨ Plugin CORE äº†æ€ä¹ˆåŠï¼Ÿ

å»ºè®®ä½ å…ˆè€ƒè™‘è€ƒè™‘ä¸‰è¿:
1. ä½ çœŸçš„å‡†å¤‡å¥½ç›´é¢è…¾è®¯çš„NTæ¶æ„äº†å—ï¼Ÿ
2. ä½ ç¡®å®šè¦è‡ªå·±å»è¯»æ‡‚é‚£äº›å……æ»¡ğŸ’©çš„æ–‡æ¡£äº†å—ï¼Ÿ
3. ä½ æœ‰ä¿¡å¿ƒåœ¨ä¸å€ŸåŠ©æ¡†æ¶çš„æƒ…å†µä¸‹,é©¯æœé‚£äº›éšæ—¶å¯èƒ½å¤±æ§çš„ `group_openid` å’Œ `member_openid` å—ï¼Ÿ

å¦‚æœä½ çš„ç­”æ¡ˆæ˜¯"æˆ‘å‡†å¤‡å¥½äº†"ï¼Œé‚£...ç¥ä½ å¥½è¿å§ã€‚

---


## API å‚è€ƒ

### è£…é¥°å™¨

| è£…é¥°å™¨ | è¯´æ˜ | å‚æ•° |
|--------|------|------|
| @on_command | å‘½ä»¤è§¦å‘å™¨ | command: å‘½ä»¤å<br>description: å‘½ä»¤æè¿°<br>hidden: æ˜¯å¦éšè—(bool) |
| @on_keyword | å…³é”®è¯è§¦å‘å™¨ | *keywords: è§¦å‘å…³é”®è¯åˆ—è¡¨ |
| @on_regex | æ­£åˆ™åŒ¹é…è§¦å‘å™¨ | pattern: æ­£åˆ™è¡¨è¾¾å¼ |
| @on_event | äº‹ä»¶ç›‘å¬å™¨ | event_type: äº‹ä»¶ç±»å‹ |

### æ¶ˆæ¯å¤„ç†

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| reply | å›å¤æ¶ˆæ¯ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>content: å›å¤å†…å®¹<br>image_data: å¯é€‰çš„å›¾ç‰‡æ•°æ® | bool: æ˜¯å¦æˆåŠŸ |
| reply_image | å›å¤å›¾ç‰‡ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>image_data: å›¾ç‰‡æ•°æ®<br>use_base64: å·²å¼ƒç”¨å‚æ•° | bool: æ˜¯å¦æˆåŠŸ |
| recall_message | æ’¤å›æ¶ˆæ¯ | handler: æ¶ˆæ¯å¤„ç†å™¨ | bool: æ˜¯å¦æˆåŠŸ |
| wait_for_reply | ç­‰å¾…ç”¨æˆ·å›å¤ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | str/None: å›å¤å†…å®¹ |
| ask | è¯¢é—®é—®é¢˜ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>prompt: é—®é¢˜å†…å®¹<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | str/None: å›ç­”å†…å®¹ |
| confirm | è¯·æ±‚ç¡®è®¤ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>prompt: ç¡®è®¤å†…å®¹<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | bool: æ˜¯å¦ç¡®è®¤ |

### æ•°æ®ç®¡ç†

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| save_data | ä¿å­˜æ•°æ® | data: è¦ä¿å­˜çš„æ•°æ® | None |
| load_data | åŠ è½½æ•°æ® | æ—  | dict: åŠ è½½çš„æ•°æ® |
| set_state | è®¾ç½®çŠ¶æ€ | key: çŠ¶æ€é”®å<br>value: çŠ¶æ€å€¼ | None |
| get_state | è·å–çŠ¶æ€ | key: çŠ¶æ€é”®å<br>default: é»˜è®¤å€¼ | Any: çŠ¶æ€å€¼ |
| clear_state | æ¸…é™¤çŠ¶æ€ | key: çŠ¶æ€é”®å | None |

### äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®å†…å®¹ |
|----------|------|----------|
| EventType.MESSAGE | æ¶ˆæ¯äº‹ä»¶ | æ¶ˆæ¯å†…å®¹å’Œå…ƒæ•°æ® |
| EventType.PLUGIN_LOADED | æ’ä»¶åŠ è½½äº‹ä»¶ | æ’ä»¶ä¿¡æ¯ |
| EventType.PLUGIN_UNLOADED | æ’ä»¶å¸è½½äº‹ä»¶ | æ’ä»¶ä¿¡æ¯ |
| EventType.STATUS_CHANGED | çŠ¶æ€å˜æ›´äº‹ä»¶ | å˜æ›´ä¿¡æ¯ |
| EventType.SCHEDULED | å®šæ—¶ä»»åŠ¡äº‹ä»¶ | ä»»åŠ¡ä¿¡æ¯ |

### ç”Ÿå‘½å‘¨æœŸ

| æ–¹æ³• | è¯´æ˜ | è°ƒç”¨æ—¶æœº |
|------|------|----------|
| on_load | åŠ è½½å›è°ƒ | æ’ä»¶è¢«åŠ è½½æ—¶ |
| on_unload | å¸è½½å›è°ƒ | æ’ä»¶è¢«å¸è½½æ—¶ |
| reload | çƒ­é‡è½½ | æ‰‹åŠ¨è°ƒç”¨æ—¶ |

### æ’ä»¶çŠ¶æ€

| å±æ€§ | è¯´æ˜ | ç±»å‹ |
|------|------|------|
| enabled | æ’ä»¶æ˜¯å¦å¯ç”¨ | bool |
| maintenance | æ’ä»¶æ˜¯å¦å·²æ‹‰é—¸ | bool |

### æ’ä»¶ç®¡ç†å™¨æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| shutdown_all_plugins | ä¸€é”®æ‹‰é—¸æ‰€æœ‰æ’ä»¶ | æ—  | None |

## é…ç½®å‚è€ƒ

### å‘½ä»¤é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| command.prefix_required | æ˜¯å¦å¼ºåˆ¶è¦æ±‚å‘½ä»¤å‰ç¼€ | true |
| command.prefix | å‘½ä»¤å‰ç¼€å­—ç¬¦ | "/" |
| command.respond_to_unknown | æ˜¯å¦å“åº”æœªçŸ¥å‘½ä»¤ | true |


