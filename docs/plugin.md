# Plugin CORE V3.1.5 æ’ä»¶å¼€å‘æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªç®€å•å¥½ç”¨çš„æ’ä»¶æ¡†æ¶,å¸®ä½ è½»æ¾å®ç°å„ç§æœºå™¨äººåŠŸèƒ½ã€‚ä¸ç®¡æ˜¯æ–°æ‰‹è¿˜æ˜¯è€æ‰‹,éƒ½èƒ½å¿«é€Ÿä¸Šæ‰‹ã€‚

## æœ€æ–°ç‰¹æ€§ (V3.1.5)

#### åå°ä»»åŠ¡

ä½ å¯ä»¥ä½¿ç”¨ `start_tasks()` æ–¹æ³•æ¥è¿è¡Œåå°ä»»åŠ¡ã€‚

è¿™äº›ä»»åŠ¡ä¼šåœ¨æ’ä»¶åŠ è½½æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œå¹¶åœ¨æ’ä»¶å¸è½½æ—¶è‡ªåŠ¨åœæ­¢ï¼š

```python
def start_tasks(self):
    return [self.my_task]  # è¿”å›ä½ è¦è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨
    
async def my_task(self):
    while True:
        await self.do_something()
        await asyncio.sleep(60)
```

ä»»åŠ¡å‡½æ•°å¿…é¡»æ˜¯**å¼‚æ­¥å‡½æ•°**ï¼Œå¦åˆ™æ— æ³•æ­£å¸¸è¿è¡Œã€‚

## ä¸»è¦åŠŸèƒ½

### äº‹ä»¶ç³»ç»Ÿ

äº‹ä»¶ç³»ç»Ÿå°±åƒä¸€ä¸ª"ç›‘å¬è€…",å½“æœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿæ—¶(æ¯”å¦‚æ”¶åˆ°æ¶ˆæ¯ã€æœ‰äººåŠ ç¾¤),å®ƒä¼šé€šçŸ¥ä½ çš„æ’ä»¶:

```python
@on_event(EventType.MESSAGE)
async def on_message(self, event):
    # event.data é‡Œé¢æœ‰æ¶ˆæ¯çš„æ‰€æœ‰ä¿¡æ¯
    print(f"æ”¶åˆ°æ–°æ¶ˆæ¯: {event.data}")
```

### æ¶ˆæ¯å¤„ç†

å¯ä»¥ç”¨å‘½ä»¤ã€å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼æ¥è§¦å‘åŠŸèƒ½:

```python
# å‘½ä»¤è§¦å‘
@on_command("å¤©æ°”", "æŸ¥è¯¢å¤©æ°”")
async def weather(self, handler, content):
    await self.reply(handler, "ä»Šå¤©å¤©æ°”ä¸é”™~")

# å…³é”®è¯è§¦å‘    
@on_keyword("æ—©å®‰", "æ—©ä¸Šå¥½")
async def morning(self, handler, content):
    await self.reply(handler, "æ—©å®‰")

# æ­£åˆ™åŒ¹é…
@on_regex(r"æˆ‘(?:ä¹Ÿ)?ç©(.*?)(?:çš„|å‘¢|å•Š|å“¦)?$")
async def play_game(self, handler, content):
    game = content.split("ç©")[-1].rstrip("çš„å‘¢å•Šå“¦")
    if "ä¹Ÿ" in content:
        await self.reply(handler, f"åŸæ¥ä½ ä¹Ÿç©{game}ï¼")
    else:
        await self.set_state(f"last_game_{handler.message.group_openid}", game)
        await self.reply(handler, f"æˆ‘ä¹Ÿç©{game}ï¼")
```

### æ•°æ®å­˜å‚¨

æ’ä»¶çš„æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜,ä½ åªéœ€è¦:

```python
# ä¿å­˜æ•°æ®
await self.save_data({"åå­—": "å°æ˜", "ç­‰çº§": 5})

# è¯»å–æ•°æ®
data = await self.load_data()
print(f"åå­—æ˜¯: {data['åå­—']}")
```

### çŠ¶æ€ç®¡ç†

å¯ä»¥æ–¹ä¾¿åœ°è®°å½•å’Œæ›´æ–°çŠ¶æ€:

```python
# è®°å½•çŠ¶æ€
await self.set_state("åœ¨çº¿äººæ•°", 100)

# è·å–çŠ¶æ€
äººæ•° = self.get_state("åœ¨çº¿äººæ•°", 0)  # 0æ˜¯é»˜è®¤å€¼

# æ¸…é™¤çŠ¶æ€
await self.clear_state("åœ¨çº¿äººæ•°")
```

## é«˜çº§åŠŸèƒ½

### çƒ­é‡è½½

æ”¹äº†ä»£ç ä¸ç”¨é‡å¯,ç›´æ¥çƒ­é‡è½½:

```python
await plugin.reload()  # ä¿å­˜çŠ¶æ€å¹¶åŠ è½½æ–°ä»£ç 
```

### æ’ä»¶ä¾èµ–

å¦‚æœä½ çš„æ’ä»¶éœ€è¦ä¾èµ–å…¶ä»–æ’ä»¶:

```python
class MyPlugin(Plugin):
    dependencies = ["æ•°æ®åº“æ’ä»¶", "å·¥å…·æ’ä»¶"]
```

## FAQ

### æ’ä»¶æ— æ³•åŠ è½½ï¼Œæ€ä¹ˆåŠï¼Ÿ

1. ç¡®ä¿æ’ä»¶ç±»ç»§æ‰¿äº† `Plugin` åŸºç±»ã€‚
2. æ£€æŸ¥æ’ä»¶åç§°æ˜¯å¦å”¯ä¸€ã€‚
3. æŸ¥çœ‹æ—¥å¿—å®šä½å…·ä½“é”™è¯¯ã€‚

### å¦‚ä½•è°ƒè¯•æ’ä»¶ï¼Ÿ

- ä½¿ç”¨ `from utils.logger import bot_logger/log` æ‰“å°è°ƒè¯•ä¿¡æ¯ã€‚
- è®¾ç½®æ–­ç‚¹æˆ–ç›´æ¥åœ¨ä»£ç ä¸­æ‰“å°å˜é‡å€¼ã€‚

### æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’ä»¶çš„æ•°æ®å­˜å‚¨åœ¨ `æ ¹ç›®å½•/data/plugins/<æ’ä»¶å>/` ç›®å½•ä¸‹ã€‚

### æˆ‘ä¸æƒ³ç”¨ Plugin CORE äº†æ€ä¹ˆåŠï¼Ÿ

å»ºè®®ä½ å…ˆè€ƒè™‘è€ƒè™‘ä¸‰è¿:
1. ä½ çœŸçš„å‡†å¤‡å¥½ç›´é¢è…¾è®¯çš„NTæ¶æ„äº†å—ï¼Ÿ
2. ä½ ç¡®å®šè¦è‡ªå·±å»è¯»æ‡‚é‚£äº›å……æ»¡ğŸ’©çš„æ–‡æ¡£äº†å—ï¼Ÿ
3. ä½ æœ‰ä¿¡å¿ƒåœ¨ä¸å€ŸåŠ©æ¡†æ¶çš„æƒ…å†µä¸‹,é©¯æœé‚£äº›éšæ—¶å¯èƒ½å¤±æ§çš„ `group_openid` å’Œ `member_openid` å—ï¼Ÿ

å¦‚æœä½ çš„ç­”æ¡ˆæ˜¯"æˆ‘å‡†å¤‡å¥½äº†"ï¼Œé‚£...ç¥ä½ å¥½è¿å§ã€‚

---


## API å‚è€ƒ

### è£…é¥°å™¨

| è£…é¥°å™¨ | è¯´æ˜ | å‚æ•° |
|--------|------|------|
| @on_command | å‘½ä»¤è§¦å‘å™¨ | command: å‘½ä»¤å<br>description: å‘½ä»¤æè¿°<br>hidden: æ˜¯å¦éšè—(bool) |
| @on_keyword | å…³é”®è¯è§¦å‘å™¨ | *keywords: è§¦å‘å…³é”®è¯åˆ—è¡¨ |
| @on_regex | æ­£åˆ™åŒ¹é…è§¦å‘å™¨ | pattern: æ­£åˆ™è¡¨è¾¾å¼ |
| @on_event | äº‹ä»¶ç›‘å¬å™¨ | event_type: äº‹ä»¶ç±»å‹ |

### æ¶ˆæ¯å¤„ç†

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| reply | å›å¤æ¶ˆæ¯ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>content: å›å¤å†…å®¹ | bool: æ˜¯å¦æˆåŠŸ |
| reply_image | å›å¤å›¾ç‰‡ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>image_data: å›¾ç‰‡æ•°æ®<br>use_base64: æ˜¯å¦ä½¿ç”¨base64 | bool: æ˜¯å¦æˆåŠŸ |
| recall_message | æ’¤å›æ¶ˆæ¯ | handler: æ¶ˆæ¯å¤„ç†å™¨ | bool: æ˜¯å¦æˆåŠŸ |
| wait_for_reply | ç­‰å¾…ç”¨æˆ·å›å¤ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | str/None: å›å¤å†…å®¹ |
| ask | è¯¢é—®é—®é¢˜ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>prompt: é—®é¢˜å†…å®¹<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | str/None: å›ç­”å†…å®¹ |
| confirm | è¯·æ±‚ç¡®è®¤ | handler: æ¶ˆæ¯å¤„ç†å™¨<br>prompt: ç¡®è®¤å†…å®¹<br>timeout: è¶…æ—¶æ—¶é—´(ç§’) | bool: æ˜¯å¦ç¡®è®¤ |

### æ•°æ®ç®¡ç†

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| save_data | ä¿å­˜æ•°æ® | data: è¦ä¿å­˜çš„æ•°æ® | None |
| load_data | åŠ è½½æ•°æ® | æ—  | dict: åŠ è½½çš„æ•°æ® |
| set_state | è®¾ç½®çŠ¶æ€ | key: çŠ¶æ€é”®å<br>value: çŠ¶æ€å€¼ | None |
| get_state | è·å–çŠ¶æ€ | key: çŠ¶æ€é”®å<br>default: é»˜è®¤å€¼ | Any: çŠ¶æ€å€¼ |
| clear_state | æ¸…é™¤çŠ¶æ€ | key: çŠ¶æ€é”®å | None |

### äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®å†…å®¹ |
|----------|------|----------|
| EventType.MESSAGE | æ¶ˆæ¯äº‹ä»¶ | æ¶ˆæ¯å†…å®¹å’Œå…ƒæ•°æ® |
| EventType.PLUGIN_LOADED | æ’ä»¶åŠ è½½äº‹ä»¶ | æ’ä»¶ä¿¡æ¯ |
| EventType.PLUGIN_UNLOADED | æ’ä»¶å¸è½½äº‹ä»¶ | æ’ä»¶ä¿¡æ¯ |
| EventType.STATUS_CHANGED | çŠ¶æ€å˜æ›´äº‹ä»¶ | å˜æ›´ä¿¡æ¯ |
| EventType.SCHEDULED | å®šæ—¶ä»»åŠ¡äº‹ä»¶ | ä»»åŠ¡ä¿¡æ¯ |

### ç”Ÿå‘½å‘¨æœŸ

| æ–¹æ³• | è¯´æ˜ | è°ƒç”¨æ—¶æœº |
|------|------|----------|
| on_load | åŠ è½½å›è°ƒ | æ’ä»¶è¢«åŠ è½½æ—¶ |
| on_unload | å¸è½½å›è°ƒ | æ’ä»¶è¢«å¸è½½æ—¶ |
| reload | çƒ­é‡è½½ | æ‰‹åŠ¨è°ƒç”¨æ—¶ |
| start_tasks | åå°ä»»åŠ¡å¯åŠ¨ | æ’ä»¶åŠ è½½å®Œæˆå |

### åå°ä»»åŠ¡ç®¡ç†

| æ–¹æ³• | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| start_tasks | å¯åŠ¨åå°ä»»åŠ¡ | æ—  | List[Coroutine]: è¦è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ |
| _start_plugin_tasks | å†…éƒ¨æ–¹æ³•ï¼šå¯åŠ¨æ‰€æœ‰ä»»åŠ¡ | æ—  | None |
| _stop_plugin_tasks | å†…éƒ¨æ–¹æ³•ï¼šåœæ­¢æ‰€æœ‰ä»»åŠ¡ | æ—  | None |

## å†å²ç‰ˆæœ¬

### V3.1.0 æ›´æ–°è®°å½•

#### å‘½ä»¤éšè—åŠŸèƒ½

ç°åœ¨ä½ å¯ä»¥åˆ›å»ºéšè—å‘½ä»¤äº†ã€‚

è¿™äº›å‘½ä»¤ä¸ä¼šåœ¨å‘½ä»¤åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼Œä½†ä»ç„¶å¯ä»¥è¢«å‘½ä»¤è°ƒç”¨ï¼š

```python
@on_command("secret", "è¿™æ˜¯ä¸ªéšè—å‘½ä»¤", hidden=True)
async def secret_command(self, handler, content):
    await self.reply(handler, "ä½ å‘ç°äº†éšè—å‘½ä»¤ï¼")
```

---

## å¿«é€Ÿä¸Šæ‰‹ï¼šåˆ›å»ºæ’ä»¶

åˆ›å»ºæ’ä»¶è¶…ç®€å•,ç»§æ‰¿ `Plugin` ç±»å°±è¡Œäº†:

```python
from core.plugin import Plugin, on_command

class HelloPlugin(Plugin):
    """ä¸€ä¸ªç®€å•çš„é—®å€™æ’ä»¶"""
    
    @on_command("hello", "æ‰“ä¸ªæ‹›å‘¼")
    async def say_hello(self, handler, content):
        await self.reply(handler, "ä½ å¥½å‘€~")
```

æŠŠè¿™ä¸ªæ–‡ä»¶æ”¾åˆ° `plugins/` ç›®å½•ä¸‹,ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åŠ è½½å®ƒã€‚åˆ é™¤æ–‡ä»¶å°±ä¼šè‡ªåŠ¨å¸è½½,æ–¹ä¾¿å¾—å¾ˆã€‚
